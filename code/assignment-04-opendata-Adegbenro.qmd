---
title: "Assignment 4 - Digitizing and Open data"
author: "COMFORT ADEGBENRO"  
format:
  html:
    code-fold: false
    embed-resources: true
    toc: true
    number-sections: true
    theme: cerulean
---

# Instructions  
Once you download this script from GitHub, then:  

  - Move it into your already-created project folder structure "06_opendata", inside the "code" sub-folder.  
  - You do not need to create new scripts. You can use the class scripts to copy code from, and paste those chunks in this script. All the code needed for this assignment should be inserted in this script.  
  - I left you the scaffolding of the structure of the exercise (i.e., look on the outline to the right). However, it is your job to decide which chunks/codes you need to paste in this script to answer the questions.  
  - Make sure that when you paste chunks/codes from the class scripts, that you place the chunks/codes under the appropriate section (again, look on the outline to the right). For ex., the chunk containing the packages needed for the exercise should be under the "Setup" heading 1.  
  - Besides code, there are 3 specific questions in this script. Make sure that you produce the plot/table needed to answer them, AND that you also write down a sentence for your answer. Only showing a plot/table is not sufficient in answering the questions.  

  
# Introduction  
Now it is your turn to   

  - digitize a field boundary  
  - retrieve open data related to soil series and elevation, and   
  - create plots to explore it  

Find an agricultural field of your interest. This could be a field from a farm you have access to, or perhaps a field on a UGA research station where your studies were/are/will be conducted.  

## Question 1) Provide below the longitude and latitude of the centroid of your selected field.  

- longitude: -84.2968798
- latitude: 31.2831540 

This field is located at the Camilla Stripling Irrigation Station, in Camilla Georgia.

# Setup  
Use this section to load the necessary packages. Remember, you will to do digitizing AND open data retrieval in this same script.  

```{r packages}
#| message: false
#| warning: false

library(tidyverse) #dplyr, tidyr, ggplot2
library(sf) # geospatial vector objects
library(mapview) # interactive maps
library(elevatr) # open-source elevation data
library(stars) # geospatial raster objects
library(FedData) # open-source soil series data
library(ggspatial) # for map components 
library(ggthemes) # for theme_map()
library(patchwork) # combine multiple plots
library(leaflet.extras) # for digitizing drawing tool bar  
library(mapedit) # for creating the boundary
library(magick)
```

# Digitizing  
Use this section to digitize AND export to file (as .geojson) the boundary of your selected field. When exporting the boundary, make sure to export it to the `output` folder.  

```{r centroid}
#| message: false
#| warning: false

# A bit of wrangling
centroid = data.frame(lon = -84.2968798,
                      lat = 31.2831540) %>%
  # Transforming df into sf
  st_as_sf(coords = c("lon", "lat")) %>%

  # Assigning proper CRS
  st_set_crs(value = 4326)

# view the object and create map for digitizing
digitizing = mapview(centroid,
                     map.types = "Esri.WorldImagery")@map %>%
  addDrawToolbar()
digitizing

# digitize the boundary and save as boundary
#boundary = editMap(digitizing)
#boundary

# extract the finished component
#boundary_w  = boundary$finished
#boundary_w

#mapview(boundary_w)

#write_sf(boundary_w, 
        # "../ouput/boundary-n.geojson",
        # delete_dsn = T)
```

**NOTE**: right before you render this script for submission, comment off the digitizing code so it does not run when rendering. You will need to write a code to import your previously-created boundary at the time of rendering (I'll demo this).  

```{r boundary}
#| message: false
#| warning: false

sf::sf_use_s2(FALSE) # had an error so ran this line of code to turn off the S2 Geometry Engine.

boundary_n = read_sf("../../06_opendata/ouput/boundary-n.geojson")

mapview(boundary_n,
        map.types = "Esri.WorldImagery")
```

# Soil series  
Use this section to:   

  - retrieve SSURGO data for your field,  
  - perform the required wrangling steps, and  
  - create maps for soil series name and corn yield  

```{r soils}
soils_n = get_ssurgo(boundary_n,
                   label = "ssurgo2",
                   raw.dir = "../data/ssurgo2/raw/",
                   extraction.dir = "../data/ssurgo2/extract")
```

## Question 2) How many different soil series were found in this field? What is their names?  

```{r soils series}
soils_n$tabular$muaggatt %>%
  select(musym, muname)
```
There is only one soil series for this field and it is called the Lucy loamy sand, with 0 to 5 percent slopes.

```{r creating the series_sf}
#| warning: false
#| message: false

series_sf <- 
  # Starting with the spatial component, currently an sp object
  soils_n$spatial %>%

    # Cleaning names
  janitor::clean_names() %>%

    # Joining with the muaggatt tabular data using a common column (musym)
  left_join(soils_n$tabular$muaggatt, by = "musym") %>%

    # Cropping to the boundary
  st_intersection(boundary_n) 

series_sf
```


```{r interactive soil series}
#| warning: false
#| message: false

mapview(series_sf,
        zcol = "muname",
        map.types = "Esri.WorldImagery")
```


This shows an interactive map of the soil series. This field is a uniform one with no variability in the soil series.

```{r static soil series map}
series_map = ggplot() +
  geom_sf(data = boundary_n, alpha = 0.5) +
  geom_sf(data = series_sf,
          aes(fill = muname)) +
  scale_fill_viridis_d() +
  theme_map() +
  theme(legend.position = "right") +
  annotation_scale(location = "bl",
                   width_hint = 0.4,
                   pad_y = unit(-0.0001, "in")) +
  annotation_north_arrow(pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering())

series_map
```
Since we have only one soil series, the color scale for the soil series static map shows only one color, depicting uniformity across the field. This means the field is dominated by only one soil type (Lucy loamy sand, 0-5% slopes).

## Question 3) Was there yield data available for any crop for the soil series within your field? List below which crops had yield data available.


```{r soils tabular}
soils_n$tabular$mucropyld %>%
  head()
```

Crops with yield values are: warm season grasses, wheat, peanuts, corn, cotton, grain sorghum, alfalfa, bahiagrass hay, grass hay, bahiagrass, cool season grasses, improved bermudagrass and soybeans. All crops have yield data for non-irrigated but not irrigated yields.

## Question 4) IF your field had data for crop yield, choose one crop only. List below what was the crop you selected, and what were the different values of yield for the selected crop for these different soil series (if your field had no crop yield data, than explain so).   

Choosing the crop, Soybeans to create the yield sf object, and subsequently yield map.
```{r creating the yield_sf }
#| warning: false
#| message: false

yield_sf <- 
  # Starting with the spatial component, currently an sp object
  soils_n$spatial %>% 
  # Transforming from sp to sf
  st_as_sf() %>%
  # Cleaning names
  janitor::clean_names() %>%
  mutate(mukey = as.numeric(mukey)) %>% 
  # Joining with the muaggatt tabular data using a common column (musym)
  left_join(soils_n$tabular$mucropyld, by = "mukey") %>%
  # Cropping to the boundary
  st_intersection(boundary_n) %>%
  # Selecting only needed columns  
  select(mukey, cropname, yldunits, nonirryield.r, geom) %>%

    # Only keeping Soybeans
  filter(cropname=="Soybeans")

yield_sf 
```

The table above presents only one yield value (32 lb) for soybeans.

```{r interactive yield}
#| warning: false
#| message: false

mapview(yield_sf,
        zcol = "nonirryield.r",
        map.types = "Esri.WorldImagery")
```


Due to having one soil series, the yield is also presented as constant across the field with no variation.

```{r static yield }
yield_map <- ggplot() +
  geom_sf(data = series_sf) +
  geom_sf(data = yield_sf, aes(fill = nonirryield.r)) +
  scale_fill_viridis_b(option = "A") +
  labs(fill = "Soybeans yield (lb/ac)") +
  theme_map() +
  theme(legend.position = "right") 

yield_map
```
This is a static yield map for soybeans, which indicates a nearly constant yield across the field, with values ranging from 31.95 to 32.05 lb/ac. The lack of spatial variability means no distinct productivity zones are visible, suggesting highly uniform field performance, supported by the single soil zone as seen above.

# Elevation  
Use this section to:   

  - retrieve elevation data at the highest zoom level possible  
  - perform the required wrangling steps, and  
  - create a map for elevation  
  
```{r getting elevation data}
#| warning: false
#| message: false

elevation = get_elev_raster(boundary_n,
                            z = 14) %>%
  st_as_stars() %>%
  st_crop(boundary_n)

elevation
```
From the summary above, the elevation of this field ranged from 49.94 to 51.69 m, with a mean and median of 50.59 m and 50.53 m, respectively, indicating a very low-relief and relatively uniform landscape. This shows minimal topographic variation.

```{r interactive elevation map}
#| warning: false
#| message: false

mapview(elevation)
```

```{r creating static elevation map}
elevation_map = ggplot() +
  geom_stars(data = elevation) +
  coord_equal() +
  scale_fill_viridis_c(option = "B", na.value = "white") +
  theme_map() +
  labs(fill = "Elevation (m)") +
  theme(legend.position = "right")

elevation_map
```
The static elevation map above shows gradual change in elevation of the field. Elevation values range from approximately 50.0 m to 51.6 m, as indicated by the legend. The northwestern end of the field (upper left) is at the highest elevation, represented by yellow and orange tones, while elevation steadily decreases toward the southeastern end (lower right), where darker purple and black colors indicate the lowest areas. This is consistent with the nearly level to gentle slope (1-5%) in the soil series.

This pattern reveals a consistent slope across the field, rather than isolated depressions or mounds. The smooth color transition suggests minimal abrupt topographic changes and confirms that the landscape has low overall relief, and the total elevation difference is small (~1.75 m).

# Combining and exporting maps  
Use this section to combine your individual static maps above into one, and export it to file.  

```{r}
#| warning: false
#| message: false

#series_map + yield_map + elevation_map +
  #plot_annotation(title = "Soil series (a), Cotton yield (b), and elevation (c)",
                  #tag_levels = "a",
                  #tag_suffix = ")"
                 # ) &
  #theme(plot.title = element_text(size = 20,
                                  #hjust = 0.5))
#ggsave("../ouput/combined_maps_ass.png",
       #width = 12,
       #height = 6)

combined_maps = image_read("../ouput/combined_maps_ass.png")
print(combined_maps, info = FALSE)
```

## Question 5) Now that you can visualize all three maps together, try to explain the effect of soil series and elevation on crop yield. Which soil and elevation conditions seem to promote higher yields in this field?  

The soil map shows that the entire field had a single soil series (Lucy loamy sand), so there is no soil variability to drive spatial differences in yield. Although elevation varies a bit across the field, the total relief is only about 1.75 m and forms a smooth, uniform slope. This small change in elevation was probably insufficient to create meaningful differences in water redistribution and overall yield. As a result, the yield map shows almost no spatial variability and does not correspond to either soil or elevation. This indicates that the field performed uniformly across all areas.

# Submitting your work  
Once you have developed all the code and answers, make sure to Render this quarto file.  

**Notes on rendering**:  

- Make sure to render your work and inspect how the final html look like.  
- If it does not look professional for whatever reason, then fix the issue, re-render it, recheck.  
- Only send me your work once your html file looks professional.  
  - **DO NOT** delete the file's heading levels (# and ##). They set up the proper heading 1 and 2 levels, and I use them to guide my grading.  
  - If a given chunk is also outputting warnings or messages, inhibit this behavior by changing the chunk options `message` and `warning` to `FALSE` (I'll demo this in a moment).  
  
  - If, after rendered, 2 lines of text are connected and you wish to "break line" between them, add 2 extra spaces after the first one (I'll demo this in a moment).  

After rendering, an .html file will be created on your `code` folder.  

Rename this file to `assignment-04-opendata-LASTNAME.html`.    

For ex., mine would be `assignment-04-opendata-Bastos.html`.

Upload the **html** file to eLC by Wednesday Feb 18th 11:59 pm.  
